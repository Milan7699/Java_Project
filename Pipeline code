# JenkinsFile Pipeline Code --->

def COLOR_MAP = [
    SUCCESS: 'good',
    FAILURE: 'danger'
]

pipeline {
    agent any

    tools {
        maven "MAVEN3.9"
        jdk "JDK21"
    }

    environment {
        sonar_project_key  = 'DAV_College'
        sonar_project_name = 'DAV_College'
        EC2_USER           = "ubuntu"
        EC2_HOST           = "13.205.118.116"
        EC2_KEY_PATH       = "/var/lib/jenkins/.ssh/Deploy_web_server_key.pem"
        TOMCAT_WEBAPP_DIR  = "/var/lib/tomcat10/webapps"
    }

    stages {

        stage("Fetch Code") {
            steps {
                git branch: 'master',
                    url: 'https://github.com/rersharma/Adanace_Java_Project_using_vagrant_machines.git'
            }
        }

        stage("Unit Test") {
            steps {
                sh "mvn test"
            }
        }

        stage("Code Build") {
            steps {
                sh "mvn install -DskipTests"
            }
            post {
                success {
                    sh 'echo "Build Success......"'
                    archiveArtifacts artifacts: '**/*.war'
                }
                failure {
                    sh 'echo "Build Failure............."'
                }
            }
        }

        stage("Checkstyle Analysis") {
            steps {
                sh "mvn checkstyle:checkstyle"
            }
        }

        stage("Sonarqube upload") {
            steps {
                withSonarQubeEnv('sonarserver') {
                    timeout(time: 10, unit: 'MINUTES') {
                        sh """
                        ${tool 'sonar8.0'}/bin/sonar-scanner \
                        -Dsonar.projectKey=$sonar_project_key \
                        -Dsonar.projectName=$sonar_project_name \
                        -Dsonar.projectVersion=1.0 \
                        -Dsonar.sources=src/ \
                        -Dsonar.java.binaries=target/classes/ \
                        -Dsonar.jacoco.reportPath=target/jacoco.exe \
                        -Dsonar.java.checkstyle.reportPaths=target/checkstyle-result.xml
                        """
                    }
                }
            }
        }

        stage("Quality Gate") {
            steps {
                script {
                    def qg = waitForQualityGate()
                    if (qg.status != 'OK') {
                        error "Pipeline aborted due to quality gate failure: ${qg.status}"
                    } else {
                        sh 'echo "Work Done All Good"'
                    }
                }
            }
        }

        stage("Artifact Upload") {
            steps {
                nexusArtifactUploader(
                    nexusVersion: 'nexus3',
                    protocol: 'http',
                    nexusUrl: '65.0.137.53:8081',
                    groupId: 'QA',
                    version: "${env.BUILD_ID}-${env.BUILD_TIMESTAMP}",
                    repository: 'vprofilerpo',
                    credentialsId: 'nexuslogin',
                    artifacts: [[
                        artifactId: 'vproapp',
                        classifier: '',
                        file: 'target/vprofile-v2.war',
                        type: 'war'
                    ]]
                )
            }
        }

        stage("Deploy To Server") {
            steps {
                script {
                    echo "============Deploying To EC2============="

                    def artifactFile       = "target/*.war"
                    def artifact           = findFiles(glob: artifactFile)[0]
                    def artifactName       = artifact.name
                    def artifactPath       = artifact.path
                    def renameartifactPath = "target/ROOT.war"

                    echo "Deploying ${renameartifactPath} To Ec2 Server"

                    if (artifactName != 'ROOT.war') {
                        echo "Renaming ${artifactName} to ROOT.war"
                        sh "cp ${artifactPath} ${renameartifactPath}"
                    } else {
                        renameartifactPath = artifactPath
                        echo "Artifact Already named Root.war no need to change"
                    }

                    sh """
                    ssh -o StrictHostKeyChecking=no -i ${EC2_KEY_PATH} ${EC2_USER}@${EC2_HOST} 'sudo rm -rf ${TOMCAT_WEBAPP_DIR}/ROOT'
                    scp -o StrictHostKeyChecking=no -i ${EC2_KEY_PATH} ${renameartifactPath} ${EC2_USER}@${EC2_HOST}:${TOMCAT_WEBAPP_DIR}/ROOT.war
                    ssh -o StrictHostKeyChecking=no -i ${EC2_KEY_PATH} ${EC2_USER}@${EC2_HOST} 'sudo systemctl restart tomcat10'
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                echo 'Slack Notification'
                slackSend(
                    channel: '#all-milan-sharma',
                    color: COLOR_MAP[currentBuild.currentResult],
                    message: "*${currentBuild.currentResult}:* Job ${env.JOB_NAME} build ${env.BUILD_NUMBER}\n More Information at : ${env.BUILD_URL}"
                )
                sh "rm -rf target/*.war"
            }
        }
    }
}
